#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from docx import Document
from docx.shared import Pt
from docx.oxml.ns import qn
from docx.oxml import OxmlElement
from copy import deepcopy

def set_cell_font(cell, font_name='å®‹ä½“', font_size=9):
    """è®¾ç½®è¡¨æ ¼å•å…ƒæ ¼å†…æ‰€æœ‰æ–‡æœ¬çš„å­—ä½“ä¸ºå®‹ä½“å°5å·ï¼ˆ9ç£…ï¼‰"""
    for paragraph in cell.paragraphs:
        for run in paragraph.runs:
            run.font.name = font_name
            run._element.rPr.rFonts.set(qn('w:eastAsia'), font_name)
            run.font.size = Pt(font_size)

def modify_numbering(doc):
    """ä¿®æ”¹æ–‡æ¡£çš„ç¼–å·å®šä¹‰"""

    # è·å–ç¼–å·éƒ¨åˆ†
    numbering = doc.part.numbering_part
    if numbering is None:
        print("  âš  æ–‡æ¡£æ²¡æœ‰ç¼–å·å®šä¹‰")
        return

    root = numbering.numbering_definitions._element

    # éå†æ‰€æœ‰çš„ç¼–å·å®šä¹‰
    for abstract_num in root.findall(qn('w:abstractNum')):
        abstract_num_id = abstract_num.get(qn('w:abstractNumId'))

        # éå†æ¯ä¸ªå±‚çº§
        for lvl in abstract_num.findall(qn('w:lvl')):

            lvl_id = lvl.get(qn('w:ilvl'))

            # è·å–å½“å‰çš„æ ¼å¼
            num_fmt = lvl.find(qn('w:numFmt'))
            lvl_text = lvl.find(qn('w:lvlText'))

            if num_fmt is not None and lvl_text is not None:
                current_format = num_fmt.get(qn('w:val'))
                current_text = lvl_text.get(qn('w:val'))

                print(f"  æ‰¾åˆ°ç¼–å·å®šä¹‰ - æŠ½è±¡ID: {abstract_num_id}, å±‚çº§: {lvl_id}")
                print(f"    å½“å‰æ ¼å¼: {current_format}, æ–‡æœ¬: {current_text}")

                # æ ¹æ®å±‚çº§è®¾ç½®ä¸åŒçš„æ ¼å¼
                if lvl_id == '0':
                    # ç¬¬ä¸€å±‚ï¼šä½¿ç”¨æ‹¬å· (1)
                    lvl_text.set(qn('w:val'), '(%1)')
                    num_fmt.set(qn('w:val'), 'decimal')
                    print(f"    â†’ ä¿®æ”¹ä¸ºæ‹¬å·æ ¼å¼: (%1)")

                elif lvl_id == '1':
                    # ç¬¬äºŒå±‚ï¼šä½¿ç”¨åœ†åœˆæ•°å­— â‘ 
                    # Wordä¸æ”¯æŒç›´æ¥åœ¨ç¼–å·æ ¼å¼ä¸­ä½¿ç”¨åœ†åœˆæ•°å­—
                    # æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç¬¦å·æˆ–ä¿æŒåŸæœ‰æ ¼å¼
                    num_fmt.set(qn('w:val'), 'decimal')
                    # æ³¨æ„ï¼šè¿™é‡Œè®¾ç½®ä¸º %1ï¼Œåé¢ä¼šåœ¨æ–‡æœ¬å‰æ·»åŠ åœ†åœˆç¬¦å·
                    lvl_text.set(qn('w:val'), '%1')
                    print(f"    â†’ ä¿®æ”¹ä¸ºæ•°å­—æ ¼å¼: %1")

# æ‰“å¼€æ–‡æ¡£
doc_path = "/Users/kexiaobin/Downloads/æ•°å­—å·¥å‚æ¦‚è¦è®¾è®¡V2.0ç‰ˆ.docx"
doc = Document(doc_path)

print("å¼€å§‹å¤„ç†æ–‡æ¡£...\n")

# 1. å¤„ç†æ‰€æœ‰è¡¨æ ¼ï¼šè®¾ç½®å­—ä½“ä¸ºå®‹ä½“å°5å·ï¼ˆ9ç£…ï¼‰
print("1. å¤„ç†è¡¨æ ¼å­—ä½“...")
table_count = 0
for table in doc.tables:
    table_count += 1
    for row in table.rows:
        for cell in row.cells:
            set_cell_font(cell, font_name='å®‹ä½“', font_size=9)

print(f"âœ“ å·²å¤„ç† {table_count} ä¸ªè¡¨æ ¼çš„å­—ä½“ï¼ˆå®‹ä½“ å°5å·ï¼‰\n")

# 2. ä¿®æ”¹ç¼–å·å®šä¹‰
print("2. ä¿®æ”¹ç¼–å·æ ¼å¼...")
try:
    modify_numbering(doc)
except Exception as e:
    print(f"âš  ä¿®æ”¹ç¼–å·æ—¶å‡ºé”™: {e}")
    print("  å°†å°è¯•é€šè¿‡æ®µè½å¤„ç†...")

    # å¦‚æœç¼–å·å®šä¹‰ä¿®æ”¹å¤±è´¥ï¼Œåˆ™å¤„ç†æ®µè½
    circle_symbols = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤', 'â‘¥', 'â‘¦', 'â‘§', 'â‘¨', 'â‘©']

    for paragraph in doc.paragraphs:
        pPr = paragraph._element.pPr
        if pPr is not None:
            numPr = pPr.find(qn('w:numPr'))
            if numPr is not None:
                ilvl_elem = numPr.find(qn('w:ilvl'))
                if ilvl_elem is not None:
                    level = int(ilvl_elem.get(qn('w:val')))

                    # ç¬¬0å±‚ï¼šä¿æŒé»˜è®¤ï¼ˆå®å¿ƒç‚¹æˆ–å…¶ä»–ï¼‰
                    # ç¬¬1å±‚ï¼šæ·»åŠ åœ†åœˆç¬¦å·
                    if level == 1:
                        # åœ¨æ®µè½æ–‡æœ¬å‰æ·»åŠ åœ†åœˆç¬¦å·
                        text = paragraph.text
                        if text and text[0] not in circle_symbols:
                            # æ‰¾åˆ°ç¼–å·çš„ä½ç½®
                            for run in paragraph.runs:
                                if run.text.strip():
                                    # æ£€æŸ¥æ˜¯å¦æ˜¯æ•°å­—å¼€å¤´
                                    if run.text[0].isdigit():
                                        # æå–æ•°å­—
                                        match = re.match(r'^(\d+)', run.text)
                                        if match:
                                            num = int(match.group(1)) % 10
                                            symbol = circle_symbols[num]
                                            run.text = symbol + ' ' + run.text[len(match.group(1)):]
                                            break

# ä¿å­˜æ–‡æ¡£
output_path = "/Users/kexiaobin/Desktop/å…¶ä»–/claude code/æ•°å­—å·¥å‚æ¦‚è¦è®¾è®¡V2.0ç‰ˆ-å·²ä¿®æ”¹.docx"
doc.save(output_path)

print(f"\nâœ… æ–‡æ¡£å¤„ç†å®Œæˆï¼")
print(f"ğŸ“„ ä¿å­˜ä½ç½®ï¼š{output_path}")
print("\nä¿®æ”¹å†…å®¹ï¼š")
print("  âœ“ æ‰€æœ‰è¡¨æ ¼å†…å­—ä½“è°ƒæ•´ä¸ºï¼šå®‹ä½“ å°5å·ï¼ˆ9ç£…ï¼‰")
print("  âœ“ ç¼–å·æ ¼å¼å·²è°ƒæ•´")
print("\næ³¨æ„ï¼š")
print("  â€¢ Wordçš„ç¼–å·æ ¼å¼å¯èƒ½éœ€è¦åœ¨Wordä¸­æ‰‹åŠ¨è°ƒæ•´")
print("  â€¢ ç¬¬ä¸€å±‚ç¼–å·å·²è®¾ç½®ä¸ºæ‹¬å·æ ¼å¼ (1)")
print("  â€¢ ç¬¬äºŒå±‚å¯èƒ½éœ€è¦åœ¨Wordä¸­æ‰‹åŠ¨è®¾ç½®ä¸ºåœ†åœˆæ•°å­—")
